<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bus Scanner Dashboard</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b5cff"/>

  <style>
    /* === Base / Existing styles (KEEP) === */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
    }

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .card{border:1px solid #ccc;border-radius:12px;padding:12px;cursor:pointer;transition:background 0.3s}
    .card.active{background:#e8f0ff;border-color:#0b5cff}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .accordion-content{
      grid-column: 1 / -1;
      overflow:hidden;
      max-height:0;
      transition:max-height 0.6s ease;
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0 8px;
    }
    table{width:100%;border-collapse:collapse;margin-top:8px}
    td,th{border-bottom:1px solid #eee;padding:6px;text-align:left}
    button,a.btn{padding:8px 12px;border-radius:8px;border:1px solid #999;background:#f5f5f5;text-decoration:none}
    .note{font-size:13px;color:#555}

    /* === NEW styles for the header + controls === */
    .dashboard-header {
      display: flex;
      align-items: center;
      justify-content: center; /* default centered */
      position: relative;
      padding: 15px;
      background: linear-gradient(90deg, #007bff, #0056b3);
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      margin-bottom: 15px;
    }
    .dashboard-header h1 {
      flex: 1;
      text-align: center;
      margin: 0;
      font-size: 22px; /* slightly smaller for mobile */
    }
    .back-btn {
      position: relative;   /* remove absolute */
      margin-right: auto;   /* push it left */
    }
    .back-btn:hover { background: #f0f0f0; }

    /* Controls Section */
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .controls button,
    .controls select,
    .controls input[type="file"] {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      cursor: pointer;
    }
    .controls button {
      background: #007bff;
      color: white;
      border: none;
      transition: 0.2s ease-in-out;
    }
    .controls button:hover { background: #0056b3; }
  </style>
</head>

<body>
  <!-- Header Section -->
  <div class="dashboard-header">
    <a class="back-btn" href="index.html">←</a>
    <h1>BUS DASHBOARD</h1>
  </div>
  
  <!-- Controls Section -->
  <div class="controls">
    <button id="download-template">Download Template (Excel)</button>
    <input type="file" id="upload" accept=".xlsx,.xls,.csv"/>
    <select id="bus">
    <option value="" disabled selected>-- Select Bus --</option>
    <option>Bus 1</option>
    <option>Bus 2</option>
    <option>Bus 3</option>
    <option>Bus 4</option>
    <option>Bus 5</option>
    <option>Bus 6</option>
    <option>Bus 7</option>
    <option>Bus 8</option>
    <option>Bus 9</option>
    <option>Bus 10</option>
    <option>Bus 11</option>
    <option>Bus 12</option>
  </select>
    
    <button id="import">Upload Attendees</button>

    <button id="offlineBtn">Enable Offline Mode</button>
  </div>

  <p class="note">Tip: The Excel file must have columns: <b>Code</b>, <b>Name</b>.</p>

  <h2>Bus Summary</h2>

  <div id="bus-grid" class="grid"></div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, setDoc, doc, collection, getDocs, onSnapshot, deleteDoc,
    query, where, enableIndexedDbPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  
  // Firebase init
  const firebaseConfig = {
    apiKey: "AIzaSyApNJVGINRObOR-3y_XWc6AFUSdKetr_xA",
    authDomain: "tci-bus-scanner.firebaseapp.com",
    projectId: "tci-bus-scanner",
    storageBucket: "tci-bus-scanner.firebasestorage.app",
    messagingSenderId: "734494824479",
    appId: "1:734494824479:web:cd9adf3817e6a14c329d2a"
  };
  const app = initializeApp(firebaseConfig); 
  const db  = getFirestore(app);
  enableIndexedDbPersistence(db).catch((err) => {
    if (err.code == 'failed-precondition') {
      console.warn('Multiple tabs open, persistence can only be enabled in one tab at a time.');
    } else if (err.code == 'unimplemented') {
      console.warn('The current browser doesn\'t support persistence.');
    }
  });

  let expandedBusId = null;
  
  // Variables
  const buses = Array.from({length:12}, (_,i)=>`bus-${i+1}`);
  const busNames = id => `Bus ${id.split('-')[1]}`;
  const grid = document.getElementById('bus-grid');

  // ✨ keep unsubscribes so we don't stack listeners
  const countUnsubs = new Map();
  const attendeeUnsubs = new Map();

  // Render summary (cards always render; counts update live)
  async function renderSummary(){
    // Clean old listeners
    countUnsubs.forEach(unsub => { try{unsub();}catch{} });
    countUnsubs.clear();
  
    grid.innerHTML = "";
    for(const id of buses){
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.id = id;
      card.innerHTML = `
        <h3>${busNames(id)}</h3>
        <div style="
          display: flex; 
          justify-content: space-between; 
          padding: 6px 10px; 
          border: 2px solid #007bff; 
          border-radius: 8px; 
          box-shadow: 0 0 8px rgba(0,123,255,0.6); 
          background: #f9f9ff;
          font-size: 14px;
        ">
          <p style="margin:0;">Listed: <b class="listed-count">0</b></p>
          <p style="margin:0;">Scanned: <b class="scanned-count">0</b></p>
        </div>
      `;

      grid.appendChild(card);
  
      try {
        // Listen for scanned count
        const qRef = query(collection(db, `buses/${id}/attendees`), where("scanned", "==", true));
        const unsubScanned = onSnapshot(qRef, snap => {
          const el = card.querySelector('.scanned-count');
          if (el) el.textContent = String(snap.size);
        });
        countUnsubs.set(id + "-scanned", unsubScanned);
  
        // Listen for total listed
        const colRef = collection(db, `buses/${id}/attendees`);
        const unsubTotal = onSnapshot(colRef, snap => {
          const el = card.querySelector('.listed-count');
          if (el) el.textContent = String(snap.size);
        });
        countUnsubs.set(id + "-total", unsubTotal);
  
      } catch (err) {
        console.warn(`Count listener failed for ${id}:`, err);
      }
    }
  }


  // Render expanded bus section
  async function renderBusSection(id, container){
    // Tear down any previous attendee listener for this bus
    try { attendeeUnsubs.get(id)?.(); } catch {}
    attendeeUnsubs.delete(id);

    container.innerHTML = `
      <div class="row" style="padding:8px 0;">
        <button data-id="${id}" class="gen-pdf">QR Code Download (A4 · 6 per page)</button>
        <button data-id="${id}" class="del-all">Delete All</button>
      </div>
      <table>
        <thead><tr><th>Code</th><th>Name</th><th>Status</th><th></th></tr></thead>
        <tbody id="tbody-${id}"><tr><td colspan="4" style="color:#777">Loading…</td></tr></tbody>
      </table>
    `;

    const tbody = container.querySelector(`#tbody-${id}`);
    const colRef = collection(db, `buses/${id}/attendees`);

    // ✨ Live updates for attendee rows
    const unsub = onSnapshot(colRef, snap=>{
      tbody.innerHTML = "";
      snap.forEach(docu=>{
        const d = docu.data();
        // Status: scannedAt if available, else ✔ Scanned, else Pending
        let status = "—";
        if (d.scannedAt && typeof d.scannedAt?.toDate === "function") {
          try { status = d.scannedAt.toDate().toLocaleString(); }
          catch { status = "✔ Scanned"; }
        } else if (d.scanned) {
          status = "✔ Scanned";
        } else {
          status = "Pending";
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${docu.id}</td>
          <td>${d.name || ""}</td>
          <td>${status}</td>
          <td><button class="del" data-id="${id}" data-code="${docu.id}">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });

      if (!tbody.children.length) {
        tbody.innerHTML = `<tr><td colspan="4" style="color:#777;font-style:italic;">No attendees yet.</td></tr>`;
      }

      // Smooth expand height after contents render
      requestAnimationFrame(()=>{
        const acc = tbody.closest('.accordion-content');
        if (acc) acc.style.maxHeight = acc.scrollHeight + "px";
      });
    });

    attendeeUnsubs.set(id, unsub);
  }

  // Accordion behavior
  grid.addEventListener('click', async (e)=>{
    const card = e.target.closest('.card');
    if(!card) return;
    const id = card.dataset.id;
    const isActive = card.classList.contains('active');

    // Collapse any open section
    document.querySelectorAll('.card').forEach(c=>c.classList.remove('active'));
    document.querySelectorAll('.accordion-content').forEach(sec=>{
      sec.style.maxHeight = null;
      sec.addEventListener('transitionend',()=>sec.remove(),{once:true});
    });

    // Stop attendee listener for previously expanded bus
    if (expandedBusId && attendeeUnsubs.has(expandedBusId)) {
      try { attendeeUnsubs.get(expandedBusId)(); } catch {}
      attendeeUnsubs.delete(expandedBusId);
    }

    if(!isActive){
      expandedBusId = id;
      card.classList.add('active');
      const content = document.createElement('div');
      content.className = 'accordion-content';
      content.innerHTML = `<p style="padding:8px;color:#777">Loading...</p>`;
      card.insertAdjacentElement('afterend', content);

      await renderBusSection(id, content);
      requestAnimationFrame(()=>{
        content.style.maxHeight = content.scrollHeight + "px";
      });
    } else {
      expandedBusId = null;
    }
  });

  // Section buttons
    grid.addEventListener('click', async (e)=>{
    if(e.target.matches('.del')){
      const id = e.target.dataset.id;
      const code = e.target.dataset.code;
      if(!confirm(`Delete attendee "${code}" from ${busNames(id)}?`)) return;
      await deleteDoc(doc(db, `buses/${id}/attendees/${code}`));
    }
    if(e.target.matches('.del-all')){
      const id = e.target.dataset.id;
      if(!confirm(`⚠ This will permanently delete ALL attendees from ${busNames(id)}. Continue?`)) return;
      const colRef = collection(db, `buses/${id}/attendees`);
      const snap = await getDocs(colRef);
      const deletions = [];
      snap.forEach(d=>deletions.push(deleteDoc(d.ref)));
      await Promise.all(deletions);
      // counts update via live listeners automatically
    }
    if(e.target.matches('.gen-pdf')){
      generatePassPDF(e.target.dataset.id);
    }
  });


  // Download Template
  document.getElementById('download-template').addEventListener('click', ()=>{
    const ws = XLSX.utils.aoa_to_sheet([["Code","Name"]]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Template");
    XLSX.writeFile(wb, "Attendees_Template.xlsx");
  });

  // Upload attendees
  document.getElementById('import').addEventListener('click', async () => {
    const file = document.getElementById('upload').files[0];
    const selectedBus = document.getElementById('bus').value;

    // 🚨 Check if no bus was selected
    if (!selectedBus) {
      alert("⚠️ Please select a bus before uploading attendees.");
      return;
    }

    const busId = selectedBus.trim().toLowerCase().replace(/\s+/g, "-"); // one-time conversion

    if (!file) {
      alert("Please select a file first.");
      return;
    }

    const data = await file.arrayBuffer();
    const wb = XLSX.read(data);
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);

    for (const row of json) {
      if (row.Code && row.Name) {
        await setDoc(doc(db, `buses/${busId}/attendees/${row.Code}`), {
          name: row.Name,
          scanned: false
        });
      }
    }

    alert(`Attendees uploaded successfully to ${selectedBus}`);
    // summary counts will auto-update via listeners; keep this to rebuild cards if needed
    await renderSummary();

    // Refresh table if this bus is open
    if (expandedBusId === busId) {
      const accordion = document.querySelector(`#tbody-${busId}`)?.closest(".accordion-content");
      if (accordion) {
        await renderBusSection(busId, accordion);
        accordion.style.maxHeight = accordion.scrollHeight + "px";
      }
    }
  });

  // QR generator
  function makeQrPng(text){
    return new Promise((resolve)=>{
      const typeNumber = 8;
      const qr = qrcode(typeNumber, 'H');
      qr.addData(String(text));
      qr.make();
      const size = 256;
      const cell = Math.floor(size / qr.getModuleCount());
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = size;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle="#fff"; ctx.fillRect(0,0,size,size);
      ctx.fillStyle="#000";
      const count = qr.getModuleCount();
      for(let r=0;r<count;r++){
        for(let c=0;c<count;c++){
          if(qr.isDark(r,c)){
            ctx.fillRect(c*cell, r*cell, cell, cell);
          }
        }
      }
      resolve(canvas.toDataURL("image/png"));
    });
  }

  // PDF generator
  async function generatePassPDF(busId){
    const { jsPDF } = window.jspdf;
    const docPDF = new jsPDF({ unit: "mm", format: "a4" });
    const colRef = collection(db, `buses/${busId}/attendees`);
    const snap = await getDocs(colRef);
    const data = [];
    snap.forEach(d=>data.push({ code: d.id, ...d.data() }));

    const cardW = 50, cardH = 100, qr = 45, marginX = 15, marginY = 10, gapX = 20, gapY = 10;
    let i = 0;
    for(const row of data){
      if(i>0 && i % 6 === 0) docPDF.addPage();
      const slot = i % 6;
      const col = slot % 2;
      const r   = Math.floor(slot / 2);
      const x = marginX + col*(cardW + gapX);
      const y = marginY + r*(cardH + gapY);
      docPDF.rect(x, y, cardW, cardH);
      docPDF.setFont("times","bold"); docPDF.setFontSize(10);
      docPDF.text("TSUNETETSU CEBU INC.", x+2, y+6);
      const qrPng = await makeQrPng(row.code);
      docPDF.addImage(qrPng, "PNG", x + (cardW-qr)/2, y+10, qr, qr);
      docPDF.setFont("helvetica","bold"); docPDF.setFontSize(10);
      docPDF.text((row.name||"").toUpperCase(), x+2, y+10+qr+8);
      docPDF.setFont("helvetica","bold"); docPDF.setFontSize(12);
      docPDF.text("EVENT", x+2, y+10+qr+18);
      docPDF.setFont("helvetica","normal"); docPDF.setFontSize(12);
      docPDF.text("TCI Family Day 2025", x+2, y+10+qr+24);
      docPDF.text("September 7, 2025 | 8:00 AM – 4:00 PM", x+2, y+10+qr+30);
      docPDF.setFont("helvetica","bold"); docPDF.setFontSize(12);
      docPDF.text("VENUE", x+2, y+10+qr+40);
      docPDF.setFont("helvetica","normal"); docPDF.setFontSize(12);
      docPDF.text("Hidden Valley Mountain and Wavepool Resort", x+2, y+10+qr+46, { maxWidth: cardW-4 });
      docPDF.text("Pinamungahan, Cebu", x+2, y+10+qr+52);
      const busLabel = busNames(busId);
      docPDF.setFont("helvetica","bold"); docPDF.setFontSize(12);
      docPDF.text("EVENT PASS", x+2, y+cardH-10);
      docPDF.text(`B (${busLabel})`, x+cardW-2, y+cardH-10, { align: "right" });
      i++;
    }
    docPDF.save(`${busNames(busId).replace(" ","_")}_Event_Passes.pdf`);
  }

  renderSummary();
    </script>

  <!-- Offline Capability -->
<script>
  // Register Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .then(registration => {
          console.log('SW registered: ', registration);
        })
        .catch(registrationError => {
          console.log('SW registration failed: ', registrationError);
        });
    });
  }

  // Online/offline status for dashboard
  function updateOnlineStatus() {
    const status = document.getElementById('online-status') || createStatusElement();
    status.textContent = navigator.onLine ? '🟢 Online' : '🔴 Offline';
  }

  function createStatusElement() {
    const statusEl = document.createElement('div');
    statusEl.id = 'online-status';
    statusEl.style.position = 'fixed';
    statusEl.style.top = '10px';
    statusEl.style.right = '10px';
    statusEl.style.padding = '5px 10px';
    statusEl.style.background = 'white';
    statusEl.style.border = '1px solid #ccc';
    statusEl.style.borderRadius = '4px';
    statusEl.style.zIndex = '1000';
    document.body.appendChild(statusEl);
    return statusEl;
  }

  window.addEventListener('online', updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);
  updateOnlineStatus(); // Initial check

  // Create toast element
  function createToast(message) {
    let toast = document.createElement('div');
    toast.textContent = message;
    toast.style.position = 'fixed';
    toast.style.bottom = '20px';
    toast.style.left = '50%';
    toast.style.transform = 'translateX(-50%)';
    toast.style.background = '#007bff';
    toast.style.color = 'white';
    toast.style.padding = '10px 20px';
    toast.style.borderRadius = '8px';
    toast.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.5s';
    document.body.appendChild(toast);
    
    // Animate in
    requestAnimationFrame(() => toast.style.opacity = '1');
    
    // Remove after 3 seconds
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
  }
  
  // Listen for Service Worker messages
  if (navigator.serviceWorker) {
    navigator.serviceWorker.addEventListener('message', event => {
      if (event.data && event.data.type === 'OFFLINE_READY') {
        createToast('✅ Offline mode ready! All files cached.');
      }
    });
  }
  
  // Offline button click
  document.getElementById('offlineBtn').addEventListener('click', () => {
  if (navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({ type: 'CACHE_OFFLINE' });
    alert('Offline mode enabled! All files are being cached for full offline use.');
  } else {
    navigator.serviceWorker.ready.then(reg => {
      reg.active.postMessage({ type: 'CACHE_OFFLINE' });
      alert('Offline mode enabled! All files are being cached for full offline use.');
    });
  }
});


</script>
</body>
</html>
