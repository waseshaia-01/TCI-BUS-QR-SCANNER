<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TCI Bus QR Scanner</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b5cff"/>
  <style>
    :root {
      --primary: #0b5cff;
      --primary-dark: #084ac9;
      --success: #00c853;
      --warning: #ffab00;
      --error: #ff1744;
      --light: #ffffff;
      --dark: #333333;
      --gray: #f5f5f5;
      --gray-dark: #e0e0e0;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('BUS_IMAGE.jpg') no-repeat center center fixed;
      background-size: cover;
      color: var(--dark);
    }

    header {
      background: var(--primary);
      color: white;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 12px rgba(0,0,0,0.2);
      position: relative;
      z-index: 10;
    }
    
    header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    header h1 i {
      font-size: 24px;
    }
    
    header a.btn {
      background: white;
      color: var(--primary);
      font-weight: bold;
      padding: 10px 16px;
      border-radius: 8px;
      text-decoration: none;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    header a.btn:hover {
      background: var(--gray);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px;
    }

    .controls {
      margin-bottom: 16px;
      background: rgba(255, 255, 255, 0.9);
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 500px;
    }

    .scanner-wrap {
      display: flex;
      justify-content: center;
      width: 100%;
      margin: 16px 0;
    }

    label {
      font-weight: bold;
      margin-right: 8px;
      display: block;
      margin-bottom: 8px;
    }
    
    select {
      padding: 10px 14px;
      font-size: 16px;
      border-radius: 8px;
      border: 2px solid var(--gray-dark);
      margin-bottom: 16px;
      width: 100%;
      background: white;
    }
    
    select:focus {
      border-color: var(--primary);
      outline: none;
    }

    #reader {
      width: 90%;
      max-width: 480px;
      aspect-ratio: 1;
      position: relative;
      overflow: hidden;
      background: transparent;
      border: none;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    #reader video {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
      position: relative;
      z-index: 1;
      border-radius: 8px;
    }

    #reader .corner {
      position: absolute;
      width: 40px;
      height: 40px;
      border: 4px solid var(--success);
      z-index: 2;
    }
    
    #reader .corner.tl { top: 0; left: 0; border-right: none; border-bottom: none; }
    #reader .corner.tr { top: 0; right: 0; border-left: none; border-bottom: none; }
    #reader .corner.bl { bottom: 0; left: 0; border-right: none; border-top: none; }
    #reader .corner.br { bottom: 0; right: 0; border-left: none; border-top: none; }

    #reader::after {
      content: "";
      position: absolute;
      top: 8%;
      left: 8%;
      width: 84%;
      height: 3px;
      background: rgba(0, 200, 83, 0.9);
      box-shadow: 0 0 14px rgba(0, 200, 83, 0.7);
      animation: scanline 2.2s linear infinite;
      transition: all 0.3s ease-in-out;
      z-index: 2;
      border-radius: 3px;
    }

    #reader.scanned::after {
      background: var(--success);
      box-shadow: 0 0 28px 8px rgba(0, 200, 83, 1);
      animation: none;
    }

    @keyframes scanline {
      0%   { top: 8%; }
      100% { top: 92%; }
    }

    #status {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.9);
      text-align: center;
      font-weight: 500;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    #status.success {
      background: rgba(0, 200, 83, 0.15);
      color: var(--success);
      border-left: 4px solid var(--success);
    }
    
    #status.warning {
      background: rgba(255, 171, 0, 0.15);
      color: var(--warning);
      border-left: 4px solid var(--warning);
    }
    
    #status.error {
      background: rgba(255, 23, 68, 0.15);
      color: var(--error);
      border-left: 4px solid var(--error);
    }

    /* Offline status indicator */
    #online-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 12px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 20px;
      z-index: 1000;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    #online-status.online {
      background: rgba(0, 200, 83, 0.15);
      color: var(--success);
      border-color: var(--success);
    }
    
    #online-status.offline {
      background: rgba(255, 23, 68, 0.15);
      color: var(--error);
      border-color: var(--error);
    }
    
    .sync-indicator {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 16px;
      background: var(--primary);
      color: white;
      border-radius: 20px;
      z-index: 1000;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    .camera-permission {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 24px;
      border-radius: 12px;
      text-align: center;
      z-index: 5;
      width: 80%;
      max-width: 400px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
    
    .camera-permission button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      margin-top: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .camera-permission button:hover {
      background: var(--primary-dark);
    }
    
    @media (max-width: 600px) {
      header {
        padding: 12px 16px;
      }
      
      header h1 {
        font-size: 18px;
      }
      
      .controls {
        padding: 12px;
      }
      
      #reader {
        width: 95%;
      }
    }
  </style>
</head>
<body>
  <div id="online-status" class="online">🟢 Online</div>
  <div class="sync-indicator">🔄 Syncing data...</div>
  
  <header>
    <h1><i class="fas fa-qrcode"></i> TCI BUS QR SCANNER</h1>
    <a class="btn" href="dashboard.html"><i class="fas fa-chart-bar"></i> View Dashboard</a>
  </header>

  <main>
    <div class="controls">
      <label for="bus">Select Bus:</label>
      <select id="bus">
        <option value="" selected disabled>-- Select Bus --</option>
        <option>Bus 1</option><option>Bus 2</option><option>Bus 3</option><option>Bus 4</option>
        <option>Bus 5</option><option>Bus 6</option><option>Bus 7</option><option>Bus 8</option>
        <option>Bus 9</option><option>Bus 10</option><option>Bus 11</option><option>Bus 12</option>
      </select>
    </div>
  
    <div class="scanner-wrap">
      <div id="reader">
        <div class="corner tl"></div>
        <div class="corner tr"></div>
        <div class="corner bl"></div>
        <div class="corner br"></div>
      </div>
      
      <div class="camera-permission">
        <h3>Camera Permission Required</h3>
        <p>Please allow camera access to use the QR scanner</p>
        <button id="request-camera">Allow Camera Access</button>
      </div>
    </div>
  
    <div id="status">Scanner ready. Select a bus and point the camera at a QR code.</div>
  </main>

  <script src="https://unpkg.com/html5-qrcode"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, getDoc, updateDoc, serverTimestamp,
      enableIndexedDbPersistence, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyApNJVGINRObOR-3y_XWc6AFUSdKetr_xA",
      authDomain: "tci-bus-scanner.firebaseapp.com",
      projectId: "tci-bus-scanner",
      storageBucket: "tci-bus-scanner.firebasestorage.app",
      messagingSenderId: "734494824479",
      appId: "1:734494824479:web:cd9adf3817e6a14c329d2a"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Enable offline persistence with better error handling
    enableIndexedDbPersistence(db).catch((err) => {
      if (err.code == 'failed-precondition') {
        console.warn('Multiple tabs open, persistence can only be enabled in one tab at a time.');
      } else if (err.code == 'unimplemented') {
        console.warn('The current browser doesn\'t support persistence.');
      }
    });

    const statusEl = document.getElementById('status');
    const busEl = document.getElementById('bus');
    const readerId = "reader";
    let html5QrCode = null;
    let pendingScans = []; // Store scans that need to be synced

    // Initialize the app
    window.onload = async () => {
      // Check if we have pending scans to sync
      const storedScans = localStorage.getItem('pendingScans');
      if (storedScans) {
        pendingScans = JSON.parse(storedScans);
        if (pendingScans.length > 0 && navigator.onLine) {
          trySyncPendingScans();
        }
      }
      
      // Initialize scanner
      try {
        await initScanner();
      } catch (error) {
        showError("Camera error: " + error.message);
        document.querySelector('.camera-permission').style.display = 'block';
      }
    };

    // Initialize scanner
    async function initScanner() {
      if (!html5QrCode) {
        html5QrCode = new Html5Qrcode(readerId);
      }
      
      try {
        await html5QrCode.start(
          { facingMode: { exact: "environment" } },
          { fps: 10, qrbox: { width: 250, height: 250 } },
          onScanSuccess,
          onScanFailure
        );
        showSuccess("Scanner started. Point camera at a QR code.");
        document.querySelector('.camera-permission').style.display = 'none';
      } catch (error) {
        throw error;
      }
    }

    // Request camera permission button
    document.getElementById('request-camera').addEventListener('click', async () => {
      try {
        await initScanner();
      } catch (error) {
        showError("Still unable to access camera: " + error.message);
      }
    });

    function showSuccess(msg) {
      statusEl.textContent = msg;
      statusEl.className = 'success';
    }

    function showWarning(msg) {
      statusEl.textContent = msg;
      statusEl.className = 'warning';
    }

    function showError(msg) {
      statusEl.textContent = msg;
      statusEl.className = 'error';
    }

    function showInfo(msg) {
      statusEl.textContent = msg;
      statusEl.className = '';
    }

    function onScanFailure(error) {
      // Mostly silent handling of scanning failures
      console.log("Scan failed: ", error);
    }

    async function onScanSuccess(decodedText) {
      const busName = busEl.value;
      const code = decodedText.trim();

      // Visual feedback for scan
      const readerBox = document.getElementById("reader");
      readerBox.classList.add("scanned");
      setTimeout(() => readerBox.classList.remove("scanned"), 800);

      if (!busName) {
        showWarning("⚠️ Please select a bus first.");
        return;
      }

      showInfo(`Scanned: ${code} | Checking ${busName}...`);

      const busId = busName.toLowerCase().replace(" ", "-");
      const attendeeRef = doc(db, `buses/${busId}/attendees/${code}`);

      try {
        const snap = await getDoc(attendeeRef);
        
        if (!snap.exists()) {
          showError("❌ Not found in this bus list.");
          return;
        }

        const data = snap.data();
        if (data.scanned) {
          showWarning(`⚠️ Already scanned at ${formatDate(data.scannedAt?.toDate?.() || data.scannedAt)}`);
          return;
        }

        // Try to update in Firebase
        try {
          await updateDoc(attendeeRef, { scanned: true, scannedAt: serverTimestamp() });
          showSuccess("✅ Marked as scanned.");
        } catch (updateError) {
          if (!navigator.onLine) {
            // Store scan for later sync
            const scanData = {
              busId,
              code,
              timestamp: new Date().toISOString()
            };
            
            pendingScans.push(scanData);
            localStorage.setItem('pendingScans', JSON.stringify(pendingScans));
            showWarning("⚠️ Offline - Scan saved and will sync when online");
          } else {
            showError("❌ Error: " + updateError.message);
          }
        }
      } catch (error) {
        showError("❌ Error: " + error.message);
      }
    }

    function formatDate(date) {
      if (!date) return 'unknown time';
      
      if (typeof date === 'string') {
        date = new Date(date);
      }
      
      return date.toLocaleTimeString();
    }

    // Try to sync pending scans when online
    async function trySyncPendingScans() {
      if (pendingScans.length === 0 || !navigator.onLine) return;
      
      const syncIndicator = document.querySelector('.sync-indicator');
      syncIndicator.style.display = 'flex';
      
      try {
        const batch = writeBatch(db);
        let syncedCount = 0;
        
        for (const scan of pendingScans) {
          const attendeeRef = doc(db, `buses/${scan.busId}/attendees/${scan.code}`);
          batch.update(attendeeRef, { 
            scanned: true, 
            scannedAt: serverTimestamp(),
            offlineSynced: true
          });
          syncedCount++;
        }
        
        await batch.commit();
        
        // Remove synced scans
        pendingScans = [];
        localStorage.removeItem('pendingScans');
        
        syncIndicator.style.display = 'none';
        showSuccess(`✅ Synced ${syncedCount} offline scans`);
        
        // Hide success message after 3 seconds
        setTimeout(() => {
          showInfo("Scanner ready. Select a bus and point the camera at a QR code.");
        }, 3000);
      } catch (error) {
        console.error("Error syncing scans: ", error);
        syncIndicator.style.display = 'none';
        showWarning("⚠️ Some scans couldn't be synced. They will retry later.");
      }
    }
  </script>

  <!-- Offline Capability -->
  <script>
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(registration => {
            console.log('SW registered: ', registration);
            
            // Check for updates
            if (registration.waiting) {
              console.log('New service worker waiting');
            }
            
            registration.addEventListener('updatefound', () => {
              console.log('Service worker update found');
            });
          })
          .catch(registrationError => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }

    // Online/offline status
    function updateOnlineStatus() {
      const statusEl = document.getElementById('online-status');
      
      if (navigator.onLine) {
        statusEl.textContent = '🟢 Online';
        statusEl.className = 'online';
        
        // Try to sync pending scans when coming online
        setTimeout(() => {
          if (window.trySyncPendingScans) {
            trySyncPendingScans();
          }
        }, 1000);
      } else {
        statusEl.textContent = '🔴 Offline';
        statusEl.className = 'offline';
      }
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    
    // Initial status check
    updateOnlineStatus();
  </script>
</body>
</html>
