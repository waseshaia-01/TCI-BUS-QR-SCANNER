<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TCI Bus Face Scanner</title>
  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;

      /* Background bus theme */
      background: url('BUS_IMAGE.jpg') no-repeat center center fixed;
      background-size: cover;
    }

    header {
      background: #0b5cff;
      color: white;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: bold;
    }
    header a.btn {
      background: white;
      color: #0b5cff;
      font-weight: bold;
      padding: 8px 14px;
      border-radius: 8px;
      text-decoration: none;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center; /* keeps dropdown centered */
      padding: 16px;
    }

    /* Top controls stay at the top with some spacing */
    .controls {
      margin-bottom: 16px; /* space below dropdown */
    }

    /* Scanner gets the rest of the space and centers itself */
    .scanner-wrap {
      display: flex;
      justify-content: center;
      width: 100%;   /* important: allows flex centering */
    }

    label {
      font-weight: bold;
      margin-right: 8px;
    }
    select {
      padding: 8px 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 16px;
    }

    /* Face scanner box */
    #face-scanner {
      width: 90%;
      max-width: 480px;
      aspect-ratio: 1;
      position: relative;
      overflow: hidden;
      background: transparent;
      border: none;
    }

    #face-scanner video {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
      position: relative;
      z-index: 1;
      border-radius: 8px;
      border: 2px solid #0b5cff;
    }

    #face-scanner canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
    }

    /* Status message */
    #face-status {
      margin-top: 15px;
      font-size: 16px;
      font-weight: bold;
      color: white;
      text-align: center;
      background: rgba(0,0,0,0.7);
      padding: 8px 16px;
      border-radius: 8px;
    }

    /* Attendee list */
    .attendee-list {
      margin-top: 20px;
      width: 90%;
      max-width: 480px;
      background: rgba(255,255,255,0.9);
      border-radius: 8px;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
    }

    .attendee {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
    }

    .attendee.scanned {
      background: #e0ffe0;
    }
  </style>
</head>
<body>
  <header>
    <h1>TCI BUS FACE SCANNER</h1>
    <a class="btn" href="dashboard.html">View Dashboard</a>
  </header>

  <main>
    <div class="controls">
      <label for="bus">Select Bus:</label>
      <select id="bus">
        <option value="" selected disabled>-- Select Bus --</option>
        <option>Bus 1</option><option>Bus 2</option><option>Bus 3</option><option>Bus 4</option>
        <option>Bus 5</option><option>Bus 6</option><option>Bus 7</option><option>Bus 8</option>
        <option>Bus 9</option><option>Bus 10</option><option>Bus 11</option><option>Bus 12</option>
      </select>
    </div>
  
    <!-- Face scanner wrapper -->
    <div class="scanner-wrap">
      <div id="face-scanner">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
      </div>
    </div>
  
    <div id="face-status">Status: Waiting for bus selection...</div>
    <div id="attendeeList" class="attendee-list"></div>
  </main>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <!-- Firebase (ESM modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, getDoc, updateDoc, serverTimestamp,
      collection, getDocs, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAjypFIncOMzfG_lgAELrDTnrJ_2-ZWuFA",
      authDomain: "bus-scanner-50fe9.firebaseapp.com",
      projectId: "bus-scanner-50fe9",
      storageBucket: "bus-scanner-50fe9.firebasestorage.app",
      messagingSenderId: "552524740644",
      appId: "1:552524740644:web:3cdb346ae7d9b2850d80b1"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const faceStatus = document.getElementById('face-status');
    const busEl = document.getElementById('bus');
    const attendeeList = document.getElementById('attendeeList');
    const ctx = canvas.getContext('2d');
    let faceMatcher = null;
    let currentBusId = null;

    // Load models
    async function loadModels() {
      try {
        faceStatus.textContent = "Loading face detection models...";
        await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
        await faceapi.nets.faceLandmark68Net.loadFromUri('/models');
        await faceapi.nets.faceRecognitionNet.loadFromUri('/models');
        faceStatus.textContent = "Models loaded. Select a bus to begin.";
      } catch (err) {
        console.error("Model loading error:", err);
        faceStatus.textContent = "Error loading face detection models";
      }
    }

    // Start camera
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          } 
        });
        video.srcObject = stream;
        
        video.onplay = () => {
          // Set canvas size to match video
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          
          // Start detection loop
          detectFaces();
        };
      } catch (err) {
        console.error("Camera error:", err);
        faceStatus.textContent = "Camera error: " + err.message;
      }
    }

    // Load known faces from Firebase
    async function loadKnownFaces() {
      if (!currentBusId) return;
      
      faceStatus.textContent = "Loading known faces for " + currentBusId + "...";
      const busId = currentBusId.toLowerCase().replace(" ", "-");
      const colRef = collection(db, `buses/${busId}/attendees`);
      const snap = await getDocs(colRef);
      
      const labeledDescriptors = [];
      snap.forEach(doc => {
        const data = doc.data();
        if (data.faceDescriptor) {
          labeledDescriptors.push(
            new faceapi.LabeledFaceDescriptors(
              doc.id, 
              [new Float32Array(data.faceDescriptor)]
            )
          );
        }
      });
      
      if (labeledDescriptors.length > 0) {
        faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
        faceStatus.textContent = "Ready to scan. " + labeledDescriptors.length + " faces loaded.";
      } else {
        faceStatus.textContent = "No faces enrolled for this bus. Use dashboard to enroll faces.";
        faceMatcher = null;
      }
      
      // Load attendee list
      loadAttendees();
    }

    // Main detection loop
    async function detectFaces() {
      if (!faceMatcher || !currentBusId) {
        requestAnimationFrame(detectFaces);
        return;
      }

      const detections = await faceapi.detectAllFaces(
        video, 
        new faceapi.TinyFaceDetectorOptions()
      ).withFaceLandmarks().withFaceDescriptors();
      
      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw detections
      const resizedDetections = faceapi.resizeResults(detections, { width: video.videoWidth, height: video.videoHeight });
      faceapi.draw.drawDetections(canvas, resizedDetections);
      faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
      
      if (detections.length > 0) {
        const bestMatch = faceMatcher.findBestMatch(detections[0].descriptor);
        
        if (bestMatch.distance < 0.5) { // Confidence threshold
          faceStatus.textContent = `Recognized: ${bestMatch.label}`;
          await markAttendeeScanned(bestMatch.label);
        } else {
          faceStatus.textContent = "Unknown face detected";
        }
      } else {
        faceStatus.textContent = "Ready to scan. Looking for faces...";
      }
      
      // Continue detection
      requestAnimationFrame(detectFaces);
    }

    // Mark attendee as scanned
    async function markAttendeeScanned(code) {
      const busId = currentBusId.toLowerCase().replace(" ", "-");
      const attendeeRef = doc(db, `buses/${busId}/attendees/${code}`);
      
      const snap = await getDoc(attendeeRef);
      if (!snap.exists()) return;
      
      const data = snap.data();
      if (data.scanned) {
        faceStatus.textContent = `⚠️ Already scanned at ${data.scannedAt?.toDate?.() || data.scannedAt}`;
        return;
      }
      
      await updateDoc(attendeeRef, { 
        scanned: true, 
        scannedAt: serverTimestamp() 
      });
      faceStatus.textContent = "✅ " + (data.name || code) + " marked as scanned!";
      
      // Update attendee list
      loadAttendees();
    }

    // Load attendees list
    async function loadAttendees() {
      if (!currentBusId) return;
      
      const busId = currentBusId.toLowerCase().replace(" ", "-");
      attendeeList.innerHTML = "";
      
      const q = await getDocs(collection(db, "buses", busId, "attendees"));
      q.forEach((docSnap) => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "attendee" + (data.scanned ? " scanned" : "");
        div.innerHTML = `
          <span>${data.name || docSnap.id}</span>
          <span>${data.scanned ? "✔ Scanned" : "Pending"}</span>
        `;
        attendeeList.appendChild(div);
      });
    }

    // Bus selection changed
    busEl.addEventListener("change", async (e) => {
      currentBusId = e.target.value;
      if (currentBusId) {
        await loadKnownFaces();
      } else {
        faceStatus.textContent = "Please select a bus";
        attendeeList.innerHTML = "";
      }
    });

    // Initialize
    loadModels().then(startCamera);
  </script>
</body>
</html>
