<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TCI Bus QR Scanner</title>
  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;

      /* Background bus theme */
      background: url('BUS_IMAGE.jpg') no-repeat center center fixed;
      background-size: cover;
    }

    header {
      background: #0b5cff;
      color: white;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: bold;
    }
    header a.btn {
      background: white;
      color: #0b5cff;
      font-weight: bold;
      padding: 8px 14px;
      border-radius: 8px;
      text-decoration: none;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center; /* keeps dropdown centered */
      padding: 16px;
    }

    /* Top controls stay at the top with some spacing */
    .controls {
      margin-bottom: 16px; /* space below dropdown */
    }

    /* Scanner gets the rest of the space and centers itself */
    .scanner-wrap {
      display: flex;
      justify-content: center;
      width: 100%;   /* important: allows flex centering */
    }

    label {
      font-weight: bold;
      margin-right: 8px;
    }
    select {
      padding: 8px 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 16px;
    }

    /* Scanner box */
    #reader {
      width: 90%;
      max-width: 480px;
      aspect-ratio: 1;
      position: relative;
      overflow: hidden;
      background: transparent;
      border: none;
    }

    #reader video {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
      position: relative;
      z-index: 1;
    }

    /* Scanner corner brackets */
    #reader .corner {
      position: absolute;
      width: 40px;
      height: 40px;
      border: 4px solid #00ff00; /* green */
    }
    
    #reader .corner.tl { top: 0; left: 0; border-right: none; border-bottom: none; }
    #reader .corner.tr { top: 0; right: 0; border-left: none; border-bottom: none; }
    #reader .corner.bl { bottom: 0; left: 0; border-right: none; border-top: none; }
    #reader .corner.br { bottom: 0; right: 0; border-left: none; border-top: none; }

    /* Scanning line */
    #reader::after {
      content: "";
      position: absolute;
      top: 8%;
      left: 8%;
      width: 84%;
      height: 3px;
      background: rgba(0, 255, 0, 0.9);
      box-shadow: 0 0 14px rgba(0, 255, 0, 0.7);
      animation: scanline 2.2s linear infinite;
      transition: all 0.3s ease-in-out;
      z-index: 2;
    }

    /* Glow effect when QR is detected */
    #reader.scanned::after {
      background: lime;
      box-shadow: 0 0 28px 8px rgba(0, 255, 0, 1);
      animation: none; /* pause animation when detected */
    }

    @keyframes scanline {
      0%   { top: 8%; }
      100% { top: 92%; }
    }
  </style>
</head>
<body>
  <header>
    <h1>TCI BUS QR SCANNER</h1>
    <a class="btn" href="dashboard.html">View Dashboard</a>
  </header>

  <main>
    <div class="controls">
      <label for="bus">Select Bus:</label>
      <select id="bus">
        <option value="" selected disabled>-- Select Bus --</option>
        <option>Bus 1</option><option>Bus 2</option><option>Bus 3</option><option>Bus 4</option>
        <option>Bus 5</option><option>Bus 6</option><option>Bus 7</option><option>Bus 8</option>
        <option>Bus 9</option><option>Bus 10</option><option>Bus 11</option><option>Bus 12</option>
      </select>
    </div>
  
    <!-- Scanner wrapper -->
    <div class="scanner-wrap">
      <div id="reader">
        <div class="corner tl"></div>
        <div class="corner tr"></div>
        <div class="corner bl"></div>
        <div class="corner br"></div>
      </div>
    </div>
  
    <div id="status"></div>
  </main>




  <!-- Libraries (CDN) -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <!-- Firebase (ESM modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, getDoc, updateDoc, serverTimestamp,
      enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDGrDtkfye4lBQkTyDC1DIJEwkW1j78HfM",
      authDomain: "bus-qr-scanner.firebaseapp.com",
      projectId: "bus-qr-scanner",
      storageBucket: "bus-qr-scanner.firebasestorage.app",
      messagingSenderId: "480236844780",
      appId: "1:480236844780:web:863d7c88a8c8144d2297c9"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    enableIndexedDbPersistence(db).catch(() => {});

    const statusEl = document.getElementById('status');
    const busEl    = document.getElementById('bus');
    const readerId = "reader";
    let html5QrCode = null;

    window.onload = async () => {
      try {
        if(!html5QrCode){
          html5QrCode = new Html5Qrcode(readerId);
        }
        await html5QrCode.start(
          { facingMode: { exact: "environment" } },
          { fps: 10, qrbox: { width: 300, height: 300 } },
          onScanSuccess
        );
        show("Scanner started. Point a QR to the camera.");
      } catch(e){
        show("Camera error: " + e);
      }
    };

    function show(msg){ statusEl.textContent = msg; }

    async function onScanSuccess(decodedText){
      const busName = busEl.value;
      const code    = decodedText.trim();

      // Glow effect on scan
      const readerBox = document.getElementById("reader");
      readerBox.classList.add("scanned");
      setTimeout(() => readerBox.classList.remove("scanned"), 800);

      if(!busName){
        show("⚠️ Please select a bus first.");
        return;
      }

      show(`Scanned: ${code} | Checking ${busName}...`);

      const busId = busName.toLowerCase().replace(" ", "-");
      const attendeeRef = doc(db, `buses/${busId}/attendees/${code}`);

      const snap = await getDoc(attendeeRef);
      if(!snap.exists()){
        show("❌ Not found in this bus list.");
        return;
      }

      const data = snap.data();
      if(data.scanned){
        show(`⚠️ Already scanned at ${data.scannedAt?.toDate?.() || data.scannedAt}`);
        return;
      }

      await updateDoc(attendeeRef, { scanned: true, scannedAt: serverTimestamp() });
      show("✅ Marked as scanned.");
    }
  </script>
</body>
</html>
